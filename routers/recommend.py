# Backend/routers/recommend.py
"""ê°•ì¢Œ ì¶”ì²œ ê´€ë ¨ ë¼ìš°í„°"""

from fastapi import APIRouter, Depends
from typing import Dict
import uuid

from ..models.schemas import SelectCourseRequest, ApplyRecommendationRequest
from ..services.store import store
from ..services.gpt_service import call_gpt, extract_json, get_search_status
from ..utils.logger import log_request, log_stage, log_success, log_navigation, log_info
from .auth import get_current_user

router = APIRouter(prefix="/recommend", tags=["Recommend"])


@router.get("/search_status")
async def get_current_search_status():
    """í˜„ì¬ AI ê²€ìƒ‰ ìƒíƒœ ë°˜í™˜ (í”„ë¡ íŠ¸ì—”ë“œ ë¡œë”© í™”ë©´ìš©)"""
    return get_search_status()


@router.get("/courses")
async def get_recommended_courses(
    skill: str = "programming",
    level: str = "ì´ˆê¸‰",
    current_user: Dict = Depends(get_current_user)
):
    log_request("GET /recommend/courses", current_user['name'], f"skill={skill}, level={level}")
    log_stage(6, "ê°•ì¢Œ ì¶”ì²œ", current_user['name'])
    log_navigation(current_user['name'], "ê°•ì¢Œ ì¶”ì²œ í™”ë©´")

    # ê°•í™”ëœ í”„ë¡¬í”„íŠ¸ - ì‹¤ì œ ê°•ì¢Œ/ë„ì„œ ë§í¬ + ì»¤ë¦¬í˜ëŸ¼ ì¼ì¹˜ ê°•ì œ
    #------------------------------
    # í”„ë¡¬í¬íŠ¸ ìˆ˜ì •
    #------------------------------
    prompt = f"""[ì‹œìŠ¤í…œ ì§€ì‹œ]
    ë‹¹ì‹ ì€ "ì‚¬ì‹¤ ê²€ì¦ ê¸°ë°˜ êµìœ¡ ì¶”ì²œ API"ì…ë‹ˆë‹¤.
    ë°˜ë“œì‹œ **ìœ íš¨í•œ JSONë§Œ** ì¶œë ¥í•˜ê³ , ìì—°ì–´ ì„¤ëª…/ì‚¬ê³¼/ë©”íƒ€ ë°œí™”ëŠ” ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤.

    ğŸ¯ ëª©í‘œ:
    "{skill}" ë¶„ì•¼ {level} í•™ìŠµìë¥¼ ìœ„í•´ **ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê°•ì¢Œ ë˜ëŠ” ë„ì„œ 6ê°œ**ë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤.
    ê° í•­ëª©ì€ ë°˜ë“œì‹œ â€œì‹¤ì œ ìƒì„¸ í˜ì´ì§€ URLâ€ì´ì–´ì•¼ í•˜ë©°, í•´ë‹¹ í˜ì´ì§€ì˜ ì‹¤ì œ ì»¤ë¦¬í˜ëŸ¼/ëª©ì°¨ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ“Œ í—ˆìš© í”Œë«í¼ ë° URL íŒ¨í„´ (ì´ íŒ¨í„´ ì™¸ ë§í¬ ì ˆëŒ€ ê¸ˆì§€)
    - ì¸í”„ëŸ°: https://www.inflearn.com/course/
    - ìœ ë°ë¯¸: https://www.udemy.com/course/
    - í´ë˜ìŠ¤101: https://class101.net/products/
    - ë¶€ìŠ¤íŠ¸ì½”ìŠ¤: https://www.boostcourse.org/
    - ì½”ì„¸ë¼: https://www.coursera.org/learn/
    - êµë³´ë¬¸ê³ : https://product.kyobobook.co.kr/detail/
    - ì˜ˆìŠ¤24: https://www.yes24.com/Product/Goods/
    - ìœ íŠœë¸Œ ë‹¨ì¼ ê°•ì˜: https://www.youtube.com/watch?v=

    âŒ ì ˆëŒ€ ê¸ˆì§€
    1. ê²€ìƒ‰ URL  
    - google.com/search  
    - search.naver.com  
    - youtube.com/results  
    - ?q=, ?search_query= ë“±  
    2. example.com í¬í•¨ URL  
    3. í”Œë«í¼ êµ¬ì¡°ì— ë§ì§€ ì•ŠëŠ” URL ìƒì„±  
    4. ìƒì„¸ í˜ì´ì§€ê°€ ì•„ë‹Œ ì¹´í…Œê³ ë¦¬/ê²€ìƒ‰/ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€  
    5. í˜ì´ì§€ ë‚´ìš©ì— ì—†ëŠ” ì»¤ë¦¬í˜ëŸ¼ ìƒì„±  
    6. JSON ì™¸ í…ìŠ¤íŠ¸ ì¶œë ¥

    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ” í•„ìˆ˜ ë™ì‘
    1) ì›¹ ë¸Œë¼ìš°ì§•ìœ¼ë¡œ ì‹¤ì œ **ê°•ì¢Œ/ë„ì„œ ìƒì„¸ í˜ì´ì§€**ë¥¼ ì°¾ìŠµë‹ˆë‹¤.  
    2) í˜ì´ì§€ ë‚´ ì‹¤ì œ ì œëª©, ê°•ì‚¬ëª…/ì €ìëª…, ê°€ê²©, ì†Œê°œ, ì»¤ë¦¬í˜ëŸ¼/ëª©ì°¨ ì„¹ì…˜ì„ ì¶”ì¶œí•©ë‹ˆë‹¤.  

    3) curriculum ë¦¬ìŠ¤íŠ¸ ì‘ì„± ê·œì¹™:
    - typeì´ "course"ì¸ ê²½ìš°:  
        ê°•ì¢Œ ìƒì„¸ í˜ì´ì§€ì— ìˆëŠ” ì„¹ì…˜/ì°¨ì‹œ/ëª¨ë“ˆ ì œëª©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - typeì´ "book"ì¸ ê²½ìš°:  
        ë„ì„œ ìƒì„¸ í˜ì´ì§€ì˜ **ëª©ì°¨(ì°¨ë¡€)** ë˜ëŠ” ì¥/íŒŒíŠ¸/ì±•í„° ì œëª©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    - curriculumì—ëŠ” ìµœì†Œ 5ê°œ ì´ìƒì˜ í•­ëª©ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    - í˜ì´ì§€ì— ì»¤ë¦¬í˜ëŸ¼/ëª©ì°¨ ì •ë³´ê°€ ê±°ì˜ ì—†ë‹¤ë©´, ê·¸ ë„ì„œëŠ” ì¶”ì²œí•˜ì§€ ë§ê³ 
        ë‹¤ë¥¸ ë„ì„œë¥¼ ì„ íƒí•˜ì—¬ 6ê°œë¥¼ ì±„ìš°ì„¸ìš”.
    - ì„ì˜ë¡œ ìƒˆ ì»¤ë¦¬í˜ëŸ¼ì„ ìƒìƒí•´ì„œ ë§Œë“¤ë©´ ì•ˆ ë©ë‹ˆë‹¤.

    4) ë§í¬ ìœ íš¨ì„± ê²€ì¦ ë³´ê³ (í•„ìˆ˜):
    - link_accessible: true/false  
    - ë§Œì•½ falseì¼ ê²½ìš° í•´ë‹¹ í•­ëª©ì€ ì œì™¸í•˜ê³  ìƒˆë¡œìš´ í•­ëª©ì„ ì°¾ì•„ 6ê°œë¥¼ ë°˜ë“œì‹œ ì±„ìš°ì„¸ìš”.

    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ğŸ“Š í•„ìˆ˜ JSON í˜•ì‹:

    ```json
    {{
    "recommendations": [
        {{
        "id": "unique_id_1",
        "title": "ìƒì„¸ í˜ì´ì§€ì˜ ì‹¤ì œ ì œëª©",
        "provider": "ì¸í”„ëŸ°/ìœ ë°ë¯¸/í´ë˜ìŠ¤101/êµë³´ë¬¸ê³  ë“±",
        "instructor": "ì‹¤ì œ ê°•ì‚¬ëª… ë˜ëŠ” ì €ìëª…",
        "type": "course ë˜ëŠ” book",
        "weeks": 4,
        "free": false,
        "rating": 45,
        "students": "1234ëª…",
        "summary": "ìƒì„¸ ì„¤ëª… 2-3ë¬¸ì¥ (ì‹¤ì œ ì†Œê°œ ë‚´ìš© ê¸°ë°˜)",
        "reason": "{level} í•™ìŠµìê°€ {skill}ì„ í•™ìŠµí•˜ê¸° ì í•©í•œ ì´ìœ ",
        "curriculum": [
            "í˜ì´ì§€ì— ìˆëŠ” ì„¹ì…˜/ì±•í„°/ëª©ì°¨ ì œëª© ê·¸ëŒ€ë¡œ",
            "ì„ì˜ ìƒì„± ê¸ˆì§€"
        ],
        "link": "https://ì‹¤ì œ-ìƒì„¸í˜ì´ì§€-URL",
        "link_accessible": true,
        "price": "55000ì›",
        "duration": "ì´ 10ì‹œê°„ ë˜ëŠ” í˜ì´ì§€ ê¸°ë°˜ ì •ë³´",
        "level_detail": "{level} ìˆ˜ì¤€"
        }}
    ]
    }}
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    âš ï¸ í•„ìˆ˜ ê·œì¹™ (AIëŠ” ë°˜ë“œì‹œ ì§€ì¼œì•¼ í•¨)

    6ê°œ ëª¨ë‘ link_accessible=true ì¸ í•­ëª©ë§Œ ë‚¨ê²¨ ìµœì¢…ì ìœ¼ë¡œ 6ê°œë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.

    ëª¨ë“  ì¶”ì²œ í•­ëª©ì—ì„œ curriculum ë°°ì—´ì€ ë¹„ì–´ ìˆìœ¼ë©´ ì•ˆ ë˜ë©°,
    ìµœì†Œ 5ê°œ ì´ìƒì˜ í•­ëª©ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

    typeì´ "book"ì¸ í•­ëª©ì˜ curriculumì€ ë°˜ë“œì‹œ ë„ì„œ ìƒì„¸ í˜ì´ì§€ì˜ ëª©ì°¨/ì±•í„° ì œëª©ì„ ê¸°ë°˜ìœ¼ë¡œ í•´ì•¼ í•©ë‹ˆë‹¤.

    URL íŒ¨í„´ê³¼ ë§ì§€ ì•Šê±°ë‚˜ ì»¤ë¦¬í˜ëŸ¼/ëª©ì°¨ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ëŠ” í•­ëª©ì€ ì œì™¸í•˜ì„¸ìš”.

    ì§€ê¸ˆë¶€í„° ìœ„ JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.
    """


    response = call_gpt(prompt, use_search=True)
    data = extract_json(response)

    if data:
        # recommendations ë˜ëŠ” courses í‚¤ ëª¨ë‘ ì§€ì›
        courses = data.get('recommendations', data.get('courses', []))
        # example.com í•„í„°ë§
        valid_courses = [c for c in courses if 'example' not in c.get('link', '').lower()]
        if valid_courses:
            log_success(f"ê°•ì¢Œ {len(valid_courses)}ê°œ ì¶”ì²œ ì™„ë£Œ")
            return valid_courses[:6]

    log_info("GPT ì‘ë‹µ ì‹¤íŒ¨, ê¸°ë³¸ ì¶”ì²œ ë°˜í™˜")
    return [
        {
            "id": str(uuid.uuid4()),
            "title": f"{skill} ì…ë¬¸ ê°•ì¢Œ - ì²˜ìŒë¶€í„° ë°°ìš°ëŠ” ì™„ë²½ ê°€ì´ë“œ",
            "provider": "ì¸í”„ëŸ°",
            "instructor": "ì „ë¬¸ ê°•ì‚¬",
            "type": "course",
            "weeks": 4,
            "free": False,
            "rating": 4.7,
            "students": "2500ëª…+",
            "summary": f"{skill}ì˜ ê¸°ì´ˆë¶€í„° ì‹¤ë¬´ í™œìš©ê¹Œì§€ ë°°ìš¸ ìˆ˜ ìˆëŠ” ì¢…í•© ê°•ì¢Œì…ë‹ˆë‹¤. ì´ˆë³´ìë„ ì‰½ê²Œ ë”°ë¼í•  ìˆ˜ ìˆë„ë¡ êµ¬ì„±ë˜ì–´ ìˆìœ¼ë©°, ì‹¤ìŠµ ì˜ˆì œë¥¼ í†µí•´ ì‹¤ë ¥ì„ í‚¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "reason": f"{level} í•™ìŠµìê°€ {skill}ì˜ ê¸°ì´ˆ ê°œë…ì„ ì²´ê³„ì ìœ¼ë¡œ ìµíˆê¸°ì— ìµœì í™”ëœ ì…ë¬¸ ê°•ì¢Œì…ë‹ˆë‹¤.",
            "curriculum": [
                "ì„¹ì…˜ 1: ì‹œì‘í•˜ê¸°",
                f"1ê°•: {skill} ì†Œê°œ ë° í•™ìŠµ ë¡œë“œë§µ",
                "2ê°•: ê°œë°œ í™˜ê²½ ì„¤ì •í•˜ê¸°",
                "3ê°•: ì²« ë²ˆì§¸ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°",
                "ì„¹ì…˜ 2: í•µì‹¬ ê°œë…",
                "4ê°•: ê¸°ë³¸ ë¬¸ë²•ê³¼ êµ¬ì¡° ì´í•´",
                "5ê°•: ë³€ìˆ˜ì™€ ë°ì´í„° íƒ€ì…",
                "6ê°•: ì¡°ê±´ë¬¸ê³¼ ë°˜ë³µë¬¸ ë§ˆìŠ¤í„°",
                "ì„¹ì…˜ 3: ì‹¤ì „ í”„ë¡œì íŠ¸",
                "7ê°•: ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ 1 - ê³„ì‚°ê¸°",
                "8ê°•: ë¯¸ë‹ˆ í”„ë¡œì íŠ¸ 2 - í•  ì¼ ëª©ë¡"
            ],
            "link": f"https://www.inflearn.com/courses?s={skill}",
            "price": "55000ì›",
            "duration": "ì´ 8ì‹œê°„ 30ë¶„",
            "level_detail": f"{level} ìˆ˜ì¤€ì— ì í•©"
        },
        {
            "id": str(uuid.uuid4()),
            "title": f"{skill} ë§ˆìŠ¤í„° í´ë˜ìŠ¤ - ì‹¤ë¬´ì—ì„œ ë°”ë¡œ ì“°ëŠ”",
            "provider": "ìœ ë°ë¯¸",
            "instructor": "ì‹œë‹ˆì–´ ê°œë°œì",
            "type": "course",
            "weeks": 6,
            "free": False,
            "rating": 4.8,
            "students": "15000ëª…+",
            "summary": f"{skill} ë¶„ì•¼ì˜ ì „ë¬¸ ì§€ì‹ì„ ìŠµë“í•  ìˆ˜ ìˆëŠ” ì‹¬í™” ê°•ì¢Œì…ë‹ˆë‹¤. ì‹¤ì œ í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©° í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì™„ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "reason": f"ê¸°ì´ˆë¥¼ ë„˜ì–´ ì‹¤ë¬´ ìˆ˜ì¤€ì˜ {skill} ì—­ëŸ‰ì„ í‚¤ìš°ê³  ì‹¶ì€ í•™ìŠµìì—ê²Œ í”„ë¡œì íŠ¸ ì¤‘ì‹¬ì˜ ì‹¬í™” í•™ìŠµì„ ì œê³µí•©ë‹ˆë‹¤.",
            "curriculum": [
                "ì„¹ì…˜ 1: ê¸°ì´ˆ ë‹¤ì§€ê¸°",
                "1ê°•: í•µì‹¬ ê°œë… ë³µìŠµ",
                "2ê°•: ê³ ê¸‰ ë¬¸ë²• ë°°ìš°ê¸°",
                "ì„¹ì…˜ 2: ì¤‘ê¸‰ ê³¼ì •",
                "3ê°•: ë””ìì¸ íŒ¨í„´ ì´í•´",
                "4ê°•: í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œ(TDD)",
                "ì„¹ì…˜ 3: ì‹¤ì „ í”„ë¡œì íŠ¸",
                "5ê°•: ëŒ€ê·œëª¨ í”„ë¡œì íŠ¸ ì„¤ê³„",
                "6ê°•: ì„±ëŠ¥ ìµœì í™” ê¸°ë²•",
                "7ê°•: ë°°í¬ ë° ìœ ì§€ë³´ìˆ˜"
            ],
            "link": f"https://www.udemy.com/courses/search/?q={skill}",
            "price": "79000ì›",
            "duration": "ì´ 15ì‹œê°„",
            "level_detail": "ì¤‘ê¸‰~ê³ ê¸‰ ìˆ˜ì¤€ì— ì í•©"
        },
        {
            "id": str(uuid.uuid4()),
            "title": f"{skill} ë¬´ë£Œ ë¶€íŠ¸ìº í”„",
            "provider": "ë¶€ìŠ¤íŠ¸ì½”ìŠ¤",
            "instructor": "ë„¤ì´ë²„ ë¶€ìŠ¤íŠ¸ìº í”„",
            "type": "course",
            "weeks": 5,
            "free": True,
            "rating": 4.6,
            "students": "50000ëª…+",
            "summary": f"ë„¤ì´ë²„ì—ì„œ ì œê³µí•˜ëŠ” ë¬´ë£Œ {skill} êµìœ¡ ê³¼ì •ì…ë‹ˆë‹¤. ì²´ê³„ì ì¸ ì»¤ë¦¬í˜ëŸ¼ê³¼ ì‹¤ìŠµ í™˜ê²½ì„ ì œê³µí•˜ë©°, ìˆ˜ë£Œì¦ë„ ë°œê¸‰ë©ë‹ˆë‹¤.",
            "reason": f"ë¹„ìš© ë¶€ë‹´ ì—†ì´ {skill}ì„ ë°°ìš°ê³  ì‹¶ì€ í•™ìŠµìì—ê²Œ ì²´ê³„ì ì¸ ë¬´ë£Œ êµìœ¡ê³¼ ìˆ˜ë£Œì¦ì„ ì œê³µí•©ë‹ˆë‹¤.",
            "curriculum": [
                "Week 1: ê¸°ì´ˆ í•™ìŠµ",
                "1ê°•: ì˜¤ë¦¬ì—”í…Œì´ì…˜",
                "2ê°•: ê¸°ë³¸ ê°œë… ì´í•´",
                "Week 2: ì‹¬í™” í•™ìŠµ",
                "3ê°•: í•µì‹¬ ê¸°ëŠ¥ ì‹¤ìŠµ",
                "4ê°•: ì½”ë“œ ë¦¬ë·° ë° í”¼ë“œë°±",
                "Week 3-4: í”„ë¡œì íŠ¸",
                "5ê°•: íŒ€ í”„ë¡œì íŠ¸ ì§„í–‰",
                "6ê°•: ë°œí‘œ ë° ìˆ˜ë£Œ"
            ],
            "link": f"https://www.boostcourse.org/search?keyword={skill}",
            "price": "ë¬´ë£Œ",
            "duration": "ì´ 40ì‹œê°„",
            "level_detail": f"{level} ìˆ˜ì¤€ì— ì í•©"
        }
    ]


@router.post("/select")
async def select_course(request: SelectCourseRequest, current_user: Dict = Depends(get_current_user)):
    log_request("POST /recommend/select", current_user['name'], f"course_id={request.course_id}")
    log_navigation(current_user['name'], "ê°•ì¢Œ ì„ íƒ â†’ ë¡œë”© í™”ë©´")
    return {"success": True, "message": "ê°•ì¢Œê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤."}
